# 设计文档：重构治理框架入口

**日期：** 2026-02-25
**主题：** 去掉 classify 技能，将变更分级决策树整合到 CLAUDE.md，在 /fix 和 /feat 中实现两阶段边界检查并自动路由

---

## 1. 概述

### 1.1 目标

- 去掉 classify 技能，简化技能体系
- 将变更分级规则整合到 CLAUDE.md 的"变更分级入口规则"中，形成直观决策树
- 在 /fix 和 /feat 技能中实现**两阶段边界检查**：
  - 启动时快速检查 - 立即检测参数，不匹配时自动路由
  - 探索阶段详细确认 - 在 /explore 中再次确认并调整
- 完全删除 `skills/classify/` 目录

### 1.2 非目标

- 不改变变更分级的核心定义（docs/fix/feat 的判断标准保持不变）
- 不改变其他技能的行为
- 不改变受保护目录的规则

### 1.3 约束

- 两阶段检查必须实现（启动时 + 探索阶段）
- 级别不匹配时必须自动路由到正确的技能流程
- CLAUDE.md 中的规则必须以决策树形式呈现
- 所有变更级别命名统一使用小写：docs、fix、feat

### 1.4 成功标准

- 用户可以直接使用 /fix 或 /feat，无需先调用 classify
- 使用错误的技能时，系统能自动检测并路由
- 删除 classify 后，技能体系完整可用
- CLAUDE.md 中的决策树清晰易懂

---

## 2. 架构设计

```
┌─────────────────────────────────────────────────────┐
│                    CLAUDE.md                        │
│  ┌─────────────────────────────────────────────┐   │
│  │   变更分级入口规则（决策树形式）              │   │
│  └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────┘
                          │
         ┌────────────────┼────────────────┐
         ▼                ▼                ▼
   ┌──────────┐    ┌──────────┐    ┌──────────┐
   │   /fix   │    │  /feat   │    │ 直接对话  │
   │          │    │          │    │ (docs)   │
   └──────────┘    └──────────┘    └──────────┘
         │                │
         │    ┌───────────┴───────────┐
         │    │   两阶段边界检查        │
         │    └───────────┬───────────┘
         │                ▼
         │      ┌─────────────────┐
         │      │  级别不匹配？     │
         │      └────────┬────────┘
         │         是    │    否
         │               ▼     ▼
         │    ┌──────────┐  继续流程
         │    │ 自动路由  │
         │    └──────────┘
         ▼
    正常流程
```

---

## 3. 模块设计

### 3.1 模块 1：变更分级决策树（CLAUDE.md）

**位置：** `CLAUDE.md` → "变更分级入口规则" 部分

**职责：**
- 以决策树形式清晰呈现 docs/fix/feat 的判断规则
- 用户可据此自行判断应该使用哪个技能

**内容结构：**
```markdown
## 变更分级入口规则（决策树）

```
用户需求
    │
    ▼
┌─────────────────────────────────────────┐
│ 第一步：检查是否修改治理文档？           │
│ (docs/spec/, docs/tasks/, docs/changes/) │
└─────────────────┬───────────────────────┘
                  │
         是 ──────┴────── 否
         │                │
         ▼                ▼
   提示使用          ┌─────────────────┐
   fix/feat          │ 第二步：检查   │
                     │ 触发 feat 条件 │
                     └────────┬────────┘
                              │
                    是 ───────┴────── 否
                      │              │
                      ▼              ▼
                    /feat         ┌─────────────┐
                                  │ 第三步：检查 │
                                  │ 仅修改文档？ │
                                  └──────┬──────┘
                                   是  │  否
                                    ▼  ▼
                                 直接对话 /fix
```

**feat 触发条件：**
- 新功能开发
- 公共接口变更
- 默认值或配置语义变更
- 依赖变更
- 多模块改动
- 架构调整
- 安全 / 加密 / 账务相关变更

**fix 适用范围：**
- 小 bug 修复
- typo 修复
- 单文件逻辑修正
- 内部实现优化（不改变接口与语义）

**docs 约束：**
- 仅修改文档或注释
- 不修改治理文档（docs/spec/、docs/tasks/、docs/changes/）
```

---

### 3.2 模块 2：边界检查逻辑（技能 Prompt 前置）

**位置：**
- `skills/fix/SKILL.md`
- `skills/feat/SKILL.md`

**职责：**
- 第一阶段：启动时快速检查需求参数
- 第二阶段：探索阶段详细确认

**fix/SKILL.md 边界检查结构：**
```markdown
## 边界检查（阶段 1：启动时）

在执行流程前，先检查用户需求：

**如果触发以下任一 feat 条件：**
- 新功能开发
- 公共接口变更
- 默认值或配置语义变更
- 依赖变更
- 多模块改动
- 架构调整
- 安全 / 加密 / 账务相关变更

**则输出并停止：**
```
检测到这是一个 feat 级别变更。

触发条件：[说明具体触发条件]

请使用：/feat <你的需求描述>
```

---

## 边界检查（阶段 2：探索时）

在 /explore 阶段，如果发现需求超出以下 fix 边界：
- 涉及公共接口变更
- 涉及多个模块
- 涉及架构调整
- 需要修改依赖

**则输出并停止：**
```
经探索确认，需求超出 fix 级别边界。

超出范围：[说明具体范围]

请使用：/feat <你的需求描述>
```
```

**feat/SKILL.md 边界检查结构：**
```markdown
## 边界检查（阶段 1：启动时）

在执行流程前，先检查用户需求：

**如果仅满足以下条件（且不触发 feat 条件）：**
- 仅修改文档或注释
- 不改变代码运行行为
- 不改变公共接口
- 不改变默认值或配置语义
- 不新增或修改依赖

**则输出并停止：**
```
这是一个 docs 级别变更。

docs 级别无需使用技能，请直接描述你需要的修改。
```
```

---

### 3.3 模块 3：自动路由逻辑

**职责：** 检测到级别不匹配时，自动引导用户使用正确的技能

**实现方式：** 在技能 prompt 中输出提示，引导用户输入正确命令

**示例：**
```markdown
检测到这是一个 feat 级别变更。

触发条件：新功能 + 公共接口变更

请使用：/feat <你的需求描述>
```

---

### 3.4 模块 4：classify 技能清理

**职责：** 删除不再需要的 classify 技能

**操作：**
- 删除 `skills/classify/` 目录及所有文件

---

## 4. 数据流

### 4.1 正常流程（用户使用正确技能）

```
用户输入：/fix "修复 xxx 函数的 bug"
    │
    ▼
fix/SKILL.md 加载
    │
    ▼
┌─────────────────────────────────┐
│ 阶段 1：启动时边界检查           │
│ - 检查需求描述                   │
│ - 未触发 feat 条件 ✓             │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────────────────────┐
│ 正常流程                         │
│ - 执行 /explore                  │
│ - 执行 /doc-gen:change           │
│ - 执行 /execute                  │
└─────────────────────────────────┘
```

### 4.2 异常流程 - fix 检测到 feat 级别

```
用户输入：/fix "新增一个 API 接口"
    │
    ▼
fix/SKILL.md 加载
    │
    ▼
┌─────────────────────────────────┐
│ 阶段 1：启动时边界检查           │
│ - 检查需求描述                   │
│ - 触发 feat 条件 ✗               │
│   (新功能 + 公共接口变更)        │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────────────────────┐
│ 输出路由提示                     │
│ "检测到这是一个 feat 级别变更。"  │
│ "触发条件：新功能 + 公共接口变更" │
│                                  │
│ "请使用：/feat 新增一个 API 接口"│
└─────────────────────────────────┘
              │
              ▼
      用户重新输入 /feat
```

### 4.3 两阶段检查流程

```
用户输入：/fix "优化 xxx 模块性能"
    │
    ▼
┌─────────────────────────────────┐
│ 阶段 1：启动时快速检查           │
│ - 关键词匹配（性能优化≈feat）     │
│ - 但不确定范围，暂通过 ✓         │
└─────────────┬───────────────────┘
              │
              ▼
    进入 /explore 流程
              │
              ▼
┌─────────────────────────────────┐
│ 阶段 2：探索阶段详细确认         │
│ - 通过问答澄清需求               │
│ - 发现涉及多模块 + 架构调整      │
│ - 确认超出 fix 边界 ✗            │
└─────────────┬───────────────────┘
              │
              ▼
┌─────────────────────────────────┐
│ 输出路由提示                     │
│ "经探索确认，这是一个 feat 级别  │
│  变更（涉及多模块 + 架构调整）。" │
│                                  │
│ "请使用：/feat 优化 xxx 模块性能"│
└─────────────────────────────────┘
```

---

## 5. 错误处理

### 5.1 场景 1：模糊需求无法判断

**检测时机：** 阶段 1（启动时）

**处理方式：**
```markdown
需求描述较为模糊，无法准确判断变更级别。

请先澄清以下信息：
- 涉及哪些模块/文件？
- 预期的改动范围？

或者直接使用 /explore <需求描述> 进行需求探索。
```

### 5.2 场景 2：探索后仍无法确定级别

**检测时机：** 阶段 2（探索时）

**处理方式：**
```markdown
经过探索，需求的变更级别仍不明确。

建议：
- 倾向于更高级别（fix → feat）
- 使用 /feat 确保设计充分

请确认是否升级到 feat 流程？
```

### 5.3 场景 3：边界条件冲突

**示例：** 需求同时触发 fix 和 feat 条件

**处理方式：**
```markdown
检测到需求同时满足以下条件：
- fix 条件：单文件逻辑修正
- feat 条件：公共接口变更

根据规则，优先选择更高级别。

建议使用：/feat <需求描述>
```

---

## 6. 测试策略

### 6.1 单元测试

| 测试项 | 描述 |
|-------|------|
| 决策树规则完整性 | 确保所有变更场景都能被决策树覆盖 |
| 边界检查逻辑 | 确保启动时边界检查正确识别级别 |

### 6.2 集成测试

| 场景 | 描述 |
|------|------|
| 正常 fix 流程 | 验证 fix 完整流程正常工作 |
| 自动路由流程 | 验证检测到级别不匹配时正确路由 |
| 两阶段检查 | 验证探索阶段发现级别不匹配时正确路由 |

### 6.3 回归测试

| 测试项 | 描述 |
|-------|------|
| 其他技能不受影响 | 验证 /explore、/design、/doc-gen、/execute 行为不变 |
| 受保护目录规则 | 验证受保护目录拒绝机制正常 |

### 6.4 用户验收测试

| 测试项 | 描述 |
|-------|------|
| 决策树可读性 | 验证非技术用户能理解决策树 |
| 路由提示清晰性 | 验证路由提示清晰易懂 |

---

## 7. 实施计划

实施将分为以下 Tasks：

1. 更新 CLAUDE.md - 整合决策树
2. 更新 fix/SKILL.md - 添加边界检查
3. 更新 feat/SKILL.md - 添加边界检查
4. 更新 docs/SKILL.md - 统一命名为 docs
5. 删除 classify 技能
6. 回归测试

详细 Tasks 见 `docs/tasks/remove-classify-skill.tasks.md`
