# Design: 全局治理文档约束机制

**Date:** 2026-02-25
**Status:** Draft
**Owner:** Claude

---

## 1. Goal

让 `CLAUDE.md` 中的受保护目录规则真正全局生效。通过在 CLAUDE.md 中添加分层检查指令，确保 AI 在处理任何请求前自动判断变更级别和受保护目录，防止用户绕过约束直接修改治理文档。

---

## 2. Non-Goals

- 不修改技能代码
- 不依赖系统级自动路由支持
- 不改变现有的 L1/L2/L3 判断标准

---

## 3. Constraints

- 必须适用于任何项目（全局生效）
- 依赖 AI 遵守 CLAUDE.md 中的指令
- 受保护目录：`docs/spec/`、`docs/tasks/`、`docs/changes/`

---

## 4. Architecture Design

### 4.1 整体架构

```
用户输入
    ↓
┌─────────────────────────────────────┐
│   第一层：请求入口检查                │
│   - 分析请求意图                     │
│   - 检查是否涉及受保护目录           │
│   - 如果是：拒绝并提示 /classify      │
│   - 如果否：继续处理                 │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│   正常处理流程                       │
│   - 执行用户请求                     │
│   - 准备修改操作                     │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│   第二层：操作执行检查                │
│   - 检查目标文件路径                 │
│   - 是否包含受保护目录？             │
│   - 如果是：拒绝并提示正确流程        │
│   - 如果否：执行修改                 │
└─────────────────────────────────────┘
```

### 4.2 分层检查方案（方案 C）

- **第一层：请求入口检查**
  - 收到用户输入时立即检查
  - 涉及受保护目录则拒绝并提示

- **第二层：操作执行检查**
  - 在 Edit/Write 操作前检查
  - 路径匹配受保护目录则拒绝

---

## 5. Module Design

### 5.1 入口检查模块

**位置：** CLAUDE.md 顶部

**功能：**
- 解析用户输入意图
- 识别关键词（修改、更新、删除、docs/spec/ 等）
- 判断是否涉及受保护目录

**触发条件：**
- 收到任何用户输入

**输出：**
- 涉及受保护目录 → 拒绝 + 提示使用 /classify
- 不涉及 → 继续处理

### 5.2 执行检查模块

**位置：** CLAUDE.md 中部

**功能：**
- 在 Edit/Write 操作前触发
- 检查文件路径是否包含受保护目录
- 路径模式匹配

**触发条件：**
- 准备执行 Edit 或 Write 操作

**输出：**
- 匹配受保护路径 → 拒绝 + 提示正确流程
- 不匹配 → 执行操作

### 5.3 受保护目录定义

**位置：** CLAUDE.md 独立章节

**内容：**

```markdown
## 受保护目录（全局生效）

以下目录在任何项目中都受保护，必须通过 L2/L3 流程操作：

- `docs/spec/` — 设计基准
- `docs/tasks/` — 执行记录
- `docs/changes/` — 变更历史

### 生命周期规则

| 操作 | docs/spec/ | docs/tasks/ | docs/changes/ |
|------|------------|-------------|---------------|
| 用户创建 | ❌ | ❌ | ❌ |
| 用户修改 | ❌ | ❌ | ❌ |
| 用户删除 | ❌ | ❌ | ❌ |
| L2/L3 创建 | ✅ | ✅ | ✅ |
| execute 更新 | ❌ | ✅ (ER) | ✅ (ER) |

**注：** ER = Execution Record（执行记录）
```

---

## 6. Data Flow

### 6.1 正常流程（不涉及受保护目录）

```
用户输入："修复 xxx 函数的 bug"
    ↓
【入口检查】
- 意图：修改代码
- 是否涉及受保护目录？否
- 继续处理
    ↓
【正常处理】
- 定位文件
- 准备修改
    ↓
【执行检查】
- 目标路径：src/xxx.py
- 是否包含受保护目录？否
    ↓
执行修改
```

### 6.2 受保护目录流程（被拒绝）

```
用户输入："更新 docs/spec/xxx.md 中的示例"
    ↓
【入口检查】
- 意图：修改文档
- 路径包含：docs/spec/
- 是否涉及受保护目录？是
    ↓
【拒绝操作】
"检测到修改受保护目录 docs/spec/。
受保护目录必须通过 L2/L3 流程操作。

请使用：/classify <你的需求> 判断变更级别。"
    ↓
终止
```

### 6.3 正确流程（通过 L2/L3）

```
用户输入："/classify 更新 spec 中的示例"
    ↓
【classify 判断】
- 变更级别：L2
- 提示：使用 /l2 继续流程
    ↓
用户输入："/l2 更新 spec 中的示例"
    ↓
【l2 流程】
- explore → doc-gen → execute
- 正常创建 docs/changes/xxx.md
- 正常执行修改
```

---

## 7. Error Handling

### 7.1 场景 1：用户坚持直接修改

```
用户："我就直接改一下，行不行？"
    ↓
【AI 响应】
"不行。受保护目录是治理文档，必须遵循标准流程。

你可以：
1. /classify <你的需求> — 判断变更级别
2. /l2 <你的需求> — 如果是小改动
3. /l3 <你的需求> — 如果是设计变更

这样可以确保所有变更都有记录和追踪。"
```

### 7.2 场景 2：只读操作

```
用户："查看 docs/spec/xxx.md"
    ↓
【入口检查】
- 意图：查看（read），不是修改
- 允许继续
    ↓
正常执行 Read 操作
```

### 7.3 场景 3：路径模糊

```
用户："修改 docs 下的文件"
    ↓
【入口检查】
- 路径模糊，无法确定是否受保护
    ↓
【AI 响应】
"你提到要修改 docs 下的文件。请问具体是哪个目录？

如果是以下目录，需要走 L2/L3 流程：
- docs/spec/
- docs/tasks/
- docs/changes/

请明确目标路径。"
```

### 7.4 场景 4：尝试创建治理文档

```
用户："创建 docs/changes/test.md"
    ↓
【入口检查】
- 意图：创建治理文档
- 目标：docs/changes/
- 是否允许？否
    ↓
【拒绝操作】
"治理文档只能由 L2/L3 流程创建。

请使用：
- /classify <你的需求> — 判断变更级别
- /l2 <你的需求> — L2 变更
- /l3 <你的需求> — L3 变更"
```

---

## 8. Test Strategy

### 8.1 单元测试（每个检查点）

| 测试 | 输入 | 预期结果 |
|------|------|----------|
| 入口检查-创建 | "创建 docs/changes/test.md" | 拒绝，提示 /l2 或 /l3 |
| 入口检查-修改 | "修改 docs/spec/xxx.md" | 拒绝，提示正确流程 |
| 执行检查-Edit | "补充示例" → Edit docs/spec/xxx.md | 执行检查拒绝 |
| 正确流程-L2 | /l2 "修复 bug" → 执行 | 完整流程成功 |
| 只读操作 | "查看 docs/spec/xxx.md" | 允许 |
| 非受保护目录 | "修改 src/main.py" | 允许 |
| 路径模糊 | "修改 docs 下的文件" | 询问具体路径 |

### 8.2 集成测试（完整流程）

**L2 完整流程：**
1. `/classify "修复 typo"` → 返回 L2
2. `/l2 "修复 typo"` → 创建 docs/changes/xxx.md
3. `/execute l2 docs/changes/xxx.md` → 更新 Execution Record

**L3 完整流程：**
1. `/classify "新增功能"` → 返回 L3
2. `/l3 "新增功能"` → 创建 docs/spec/xxx.spec.md
3. `/execute l3 feature:1` → 更新 Execution Record + Timeline

### 8.3 回归测试

**现有 L1 流程不受影响：**
- 用户输入："更新 README.md"
- 预期：允许，L1 流程正常工作

---

## 9. Implementation Plan

### 阶段 1：更新 CLAUDE.md

1. 在顶部添加"强制前置检查"规则
2. 在中部添加"操作执行检查"规则
3. 更新"受保护目录"章节，添加生命周期规则

### 阶段 2：测试验证

1. 测试用户直接修改受保护目录被拒绝
2. 测试 L2/L3 流程正常工作
3. 测试只读操作不受影响
4. 测试非受保护目录不受影响

### 阶段 3：文档更新

1. 更新设计文档
2. 更新 Spec
3. 更新 Tasks

---

## 10. Validation Plan

### 验收标准

- [ ] 用户直接修改受保护目录被拒绝
- [ ] 用户直接创建受保护目录被拒绝
- [ ] L2/L3 流程可以正常创建治理文档
- [ ] execute 可以正常更新 Execution Record
- [ ] 只读操作不受影响
- [ ] 非受保护目录不受影响
- [ ] 现有 L1 流程不受影响

### 验证方式

- 模拟各种用户输入，验证 AI 响应符合预期
- 完整走通 L2/L3 流程，验证正常工作
- 回归测试现有功能
