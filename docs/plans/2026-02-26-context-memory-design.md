# 上下文记忆机制设计文档

## 概述

为治理框架增加上下文记忆机制，解决项目过大导致的上下文不足问题。通过生成项目记忆文件，使新会话能够快速恢复项目上下文。

**日期：** 2026-02-26
**变更级别：** feat

---

## 方案选择

### 方案对比

| 方案 | 核心思路 | 优点 | 缺点 |
|------|----------|------|------|
| A - 扩展 execute skill | 在 execute 中自动执行记忆更新 | 修改集中，流程自动化 | execute 职责增加，需解析 tasks 判断最后一个 task |
| B - 新增 memory skill | 独立 skill 专门生成记忆 | 职责单一，灵活，易测试 | 需新增 skill，需显式调用 |
| C - 集成到 doc-gen skill | 扩展 doc-gen 增加 memory 类型 | 复用文档生成能力 | 职责增加，与现有模式不一致 |

### 推荐方案

**方案 B - 新增 memory skill**

**理由：**
1. 职责单一，代码清晰易维护
2. 灵活性高，用户可手动调用调试
3. 可独立测试和维护
4. 不影响现有 execute skill

---

## 架构设计

### 技能体系变更

```
技能体系变更：

入口层
  └── /docs

编排层
  ├── /fix
  └── /feat

核心技能层
  ├── /explore
  ├── /design
  ├── /doc-gen     # change / spec / tasks / design
  ├── /memory      # ← 新增
  └── /commit

执行层
  └── /execute
```

### 目录结构

```
~/.claude/
├── skills/
│   └── memory/           # ← 新增
└── docs/
    └── memories/         # ← 新增
        └── memory.md     # ← 唯一文件
```

### memory skill 调用

```bash
# 增量更新（最后一个 task 的 Acceptance 中）
/memory --tasks docs/tasks/xxx.tasks.md --spec docs/spec/xxx.spec.md

# 首次初始化
/memory
```

---

## 模块划分

### memory skill 职责

| 职责 | 说明 |
|------|------|
| 参数解析 | 解析 --spec、--tasks、--design 参数 |
| 文件读取 | 读取现有 memory.md 和传入的文件 |
| 生成 memory.md | 更新项目概述、架构要点、已完成功能列表、关键决策记录、文件索引 |

### memory.md 结构

```markdown
# Project Memory

## 项目概述
...

## 架构要点
...

## 已完成功能列表
...

## 关键决策记录
...

## 文件索引
| 文件路径 | 类型 | Summary |
|----------|------|---------|
| docs/spec/xxx.spec.md | spec | ... |
| docs/tasks/xxx.tasks.md | tasks | ... |
| docs/plans/xxx-design.md | design | ... |
```

---

## 数据流

```
开始
  │
  ▼
解析参数 (--spec/--tasks/--design)
  │
  ▼
读取现有 memory.md（如存在）
  │
  ▼
解析传入的 spec/tasks/design 文件
  │
  ▼
┌─────────────────────────────────┐
│ 提取信息                         │
│ - 项目概述 (spec Goal)           │
│ - 架构要点 (design 架构设计)      │
│ - 已完成功能 (tasks Execution Record) │
│ - 关键决策 (design 关键决策)      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│ 更新/生成 memory.md             │
│ - 更新各章节内容                 │
│ - 更新文件索引表格               │
└────────────┬────────────────────┘
             │
             ▼
          完成
```

---

## 错误处理

| 错误场景 | 处理方式 |
|----------|----------|
| `docs/memories/` 目录不存在 | 自动创建目录 |
| `memory.md` 文件不存在 | 生成新文件 |
| 传入的文件不存在 | 报错并终止 |
| 传入的文件解析失败 | 报错并终止 |
| memory.md 读取失败 | 报错但尝试生成新文件 |
| memory.md 写入失败 | 报错并保留原文件（如有） |
| 无参数且目录无文件 | 生成空的 memory.md 模板 |

---

## 测试策略

### 单元测试

| 测试项 | 测试内容 |
|--------|----------|
| 参数解析 | 正确解析 --spec/--tasks/--design 参数 |
| 文件读取 | 读取现有 memory.md，处理文件不存在 |
| 信息提取 | 从 spec/tasks/design 中正确提取信息 |
| memory.md 生成 | 生成符合格式的 memory.md |
| 索引更新 | 正确更新文件索引表格 |

### 集成测试

| 测试项 | 测试内容 |
|--------|----------|
| 最后一个 task Acceptance | 验证调用 `/memory` 成功更新 |
| 首次初始化 | 无参数时生成初始 memory.md |
| 增量更新 | 传入参数时正确更新对应部分 |

### 人工验证

| 验证项 | 验证方式 |
|--------|----------|
| memory.md 内容 | 检查各章节内容准确反映项目状态 |
| 文件索引 | 检查表格数据完整、链接正确 |
| 格式规范 | 检查 Markdown 渲染正常 |

---

## 更新策略

| 文件 | 更新方式 |
|------|----------|
| `memory.md` | 根据传入的文件重新生成对应部分（项目概述、架构要点、已完成功能列表、关键决策记录） |

---

## 关键决策

| 决策 | 选择 | 理由 |
|------|------|------|
| 方案选择 | 新增 memory skill | 职责单一，灵活易测试 |
| 文件数量 | 单一 memory.md | 简化维护，减少文件 |
| 更新方式 | 更新而非追加 | 项目可能被重构，需要反映最新状态 |
| 参数设计 | 可选参数 | 支持首次初始化和增量更新 |
